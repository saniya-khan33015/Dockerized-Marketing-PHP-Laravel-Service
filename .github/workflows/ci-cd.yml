name: CI/CD Pipeline

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4 # Updated to latest version

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Apply
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: |
          terraform init
          terraform apply -auto-approve
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  deploy:
    needs: terraform
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    # üö® FIX #1: If your secrets are in a "production" environment, you MUST use this line
    # environment: production 
    steps:
      - uses: actions/checkout@v4

      - name: üõ°Ô∏è Secret Validator
        run: |
          echo "Checking Secrets Visibility..."
          if [ -z "${{ secrets.EC2_HOST }}" ]; then echo "‚ùå HOST MISSING"; exit 1; fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then echo "‚ùå KEY MISSING"; exit 1; fi
          echo "‚úÖ All secrets found. Proceeding to connect to ${{ secrets.EC2_HOST }}..."

      - name: üìÇ Copy Files to EC2
        uses: appleboy/scp-action@v0.1.7 # Updated to latest stable
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "/home/ubuntu/app"
          debug: true # Detailed logs if connection fails

      - name: üöÄ Restart Application
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu/app
            echo "Current directory: $(pwd)"
            # Example restart (replace with your app's actual command):
            # pm2 restart app-test || pm2 start index.js --name "app-test"